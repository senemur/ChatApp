@using ChatApp.Domain.Entities
@model ChatApp.Domain.Entities.Conversation
@{
    ViewData["Title"] = "Sohbet";
    Layout = null;
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var otherUser = Model.Participants.FirstOrDefault(p => p.UserId != userId)?.User;
    var conversationName = Model.IsGroup ? Model.Name : otherUser?.DisplayName ?? "Bilinmeyen";
    var otherUserId = otherUser?.Id;
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@conversationName - ChatApp</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <style>
        /* Tarayıcı default margin/padding'i kaldır */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body style="margin: 0; padding: 0;">
    @Html.AntiForgeryToken()
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <a asp-action="Index" class="btn btn-sm btn-light me-2">
                ←
            </a>
            <div class="user-avatar">
                @if (Model.IsGroup)
                {
                    <span>👥</span>
                }
                else
                {
                    <span>@conversationName.Substring(0, 1).ToUpper()</span>
                }
            </div>
            <div class="chat-header-info flex-grow-1">
                <h4>@conversationName</h4>
                @if (!Model.IsGroup && otherUser != null)
                {
                    <small id="userStatus">
                        @if (otherUser.LastSeenAt.HasValue)
                        {
                            var diff = DateTime.UtcNow - otherUser.LastSeenAt.Value;
                            if (diff.TotalMinutes < 2)
                            {
                                <span><span class="online-indicator"></span>çevrimiçi</span>
                            }
                            else
                            {
                                <span>son görülme: bugün @otherUser.LastSeenAt.Value.ToLocalTime().ToString("HH:mm")</span>
                            }
                        }
                    </small>
                    <small id="typingIndicator" style="display: none;">
                        yazıyor...
                    </small>
                }
                else if (Model.IsGroup)
                {
                    <small>@Model.Participants.Count() katılımcı</small>
                }
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messagesContainer">
            <div id="messagesList">
                @{
                    DateTime? lastDate = null;
                }
                @foreach (var message in Model.Messages.OrderBy(m => m.SentAt).Where(m => !m.IsDeleted))
                {
                    var isMine = message.SenderId == userId;
                    var messageDate = message.SentAt.ToLocalTime().Date;

                    // Tarih separator (önceki gibi)
                    if (lastDate == null || messageDate != lastDate)
                    {
                        <div class="date-separator">
                            <span class="date-label">
                                @if (messageDate == DateTime.Today)
                                {
                                    @:BUGÜN
                                }
                                else if (messageDate == DateTime.Today.AddDays(-1))
                                {
                                    @:DÜN
                                }
                                else
                                {
                                    @messageDate.ToString("dd.MM.yyyy")
                                }
                            </span>
                        </div>
                        lastDate = messageDate;
                    }

                    <div class="message-wrapper @(isMine ? "mine" : "theirs")" data-message-id="@message.Id">
                        @if (isMine)
                        {
                            <button class="message-options message-options-btn" onclick="showMessageMenu(event, @message.Id)">⋮</button>
                        }

                        @if (message.Type == MessageType.Image)
                        {
                            <!-- Resim Mesajı -->
                            <div class="message-bubble has-image @(isMine ? "mine" : "theirs")">
                                @if (Model.IsGroup && !isMine)
                                {
                                    <div class="message-sender" style="padding: 8px 8px 4px;">@message.Sender.DisplayName</div>
                                }
                                <div class="image-wrapper">
                                    <img src="@message.Content"
                                         alt="Resim"
                                         class="message-image"
                                         onclick="openImageModal('@message.Content')"
                                         loading="lazy" />
                                </div>
                                <div class="message-time" style="padding: 4px 8px;">
                                    @message.SentAt.ToLocalTime().ToString("HH:mm")
                                    @if (message.IsEdited)
                                    {
                                        <span class="edited-badge">düzenlendi</span>
                                    }
                                    @if (isMine)
                                    {
                                        @if (message.ReadAt.HasValue || message.IsRead)
                                        {
                                            <span class="message-status read">✓✓</span>
                                        }
                                        else
                                        {
                                            <span class="message-status sent">✓</span>
                                        }
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Text Mesajı (önceki gibi) -->
                            <div class="message-bubble @(isMine ? "mine" : "theirs")">
                                @if (Model.IsGroup && !isMine)
                                {
                                    <div class="message-sender">@message.Sender.DisplayName</div>
                                }
                                <div class="message-content" id="message-content-@message.Id">
                                    @message.Content
                                </div>
                                <div class="message-time">
                                    @message.SentAt.ToLocalTime().ToString("HH:mm")
                                    @if (message.IsEdited)
                                    {
                                        <span class="edited-badge">düzenlendi</span>
                                    }
                                    @if (isMine)
                                    {
                                        @if (message.ReadAt.HasValue || message.IsRead)
                                        {
                                            <span class="message-status read">✓✓</span>
                                        }
                                        else
                                        {
                                            <span class="message-status sent">✓</span>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Typing Indicator -->
            <div id="typingBubble" style="display: none;">
                <div class="typing-wrapper">
                    <div class="typing-bubble">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <form id="messageForm" class="chat-input-wrapper">

                <!-- Resim Yükleme Butonu -->
                <label class="file-upload-btn" title="Resim gönder">
                    📎
                    <input type="file"
                           id="imageInput"
                           accept="image/*"
                           onchange="handleImageUpload(event)" />
                </label>
                <input type="text"
                       id="messageInput"
                       class="form-control"
                       placeholder="Bir mesaj yazın"
                       autocomplete="off"
                       maxlength="1000" />
                <button type="submit" class="send-button">
                    <span>➤</span>
                </button>
            </form>
        </div>
        <!-- Upload Progress -->
        <div id="uploadProgress" style="display: none;" class="upload-progress">
            <div>📤 Yükleniyor...</div>
            <div class="upload-progress-bar" id="progressBar" style="width: 0%;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const conversationId = @Model.Id;
        const currentUserId = '@userId';
        const otherUserId = '@otherUserId';

        // SignalR bağlantısı
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .build();

        connection.start()
            .then(() => {
                console.log("✅ Bağlantı başarılı");
                connection.invoke("JoinConversation", conversationId);
            })
            .catch(err => console.error("❌ Bağlantı hatası:", err));

   

        // Yazıyor göstergesi
        connection.on("UserTyping", (userId, userName) => {
            if (userId !== currentUserId) {
                document.getElementById("typingIndicator").style.display = "block";
                document.getElementById("typingBubble").style.display = "block";
                scrollToBottom();
            }
        });

        connection.on("UserStoppedTyping", (userId) => {
            if (userId !== currentUserId) {
                document.getElementById("typingIndicator").style.display = "none";
                document.getElementById("typingBubble").style.display = "none";
            }
        });

        // Online/Offline durumu
        connection.on("UserOnline", (userId) => {
            if (userId === otherUserId) {
                document.getElementById("userStatus").innerHTML = '<span class="online-indicator"></span>çevrimiçi';
            }
        });

        connection.on("UserOffline", (userId, lastSeenAt) => {
            if (userId === otherUserId) {
                const time = new Date(lastSeenAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById("userStatus").innerHTML = `son görülme: bugün ${time}`;
            }
        });

        // Mesaj gönderme
        document.getElementById("messageForm").addEventListener("submit", (e) => {
            e.preventDefault();

            const input = document.getElementById("messageInput");
            const message = input.value.trim();

            if (message) {
                connection.invoke("SendMessage", conversationId, message)
                    .catch(err => console.error("Gönderme hatası:", err));

                input.value = "";
                connection.invoke("StopTyping", conversationId);
                input.focus();
            }
        });

        // Yazıyor göstergesi
        let typingTimer;
        let isTyping = false;

        document.getElementById("messageInput").addEventListener("input", (e) => {
            if (e.target.value.trim() && !isTyping) {
                connection.invoke("StartTyping", conversationId);
                isTyping = true;
            }

            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (isTyping) {
                    connection.invoke("StopTyping", conversationId);
                    isTyping = false;
                }
            }, 1500);
        });

        // UI'a mesaj ekleme
        function addMessageToUI(message, isMine) {
            const messagesDiv = document.getElementById("messagesList");

            const messageWrapper = document.createElement("div");
            messageWrapper.className = `message-wrapper ${isMine ? "mine" : "theirs"}`;
            messageWrapper.setAttribute('data-message-id', message.id);

            let optionsButton = '';
            if (isMine) {
                optionsButton = `<button class="message-options message-options-btn" onclick="showMessageMenu(event, ${message.id})">⋮</button>`;
            }

            let statusIcon = '';
            if (isMine) {
                // ReadAt veya isRead varsa mavi tik, yoksa gri tek tik
                if (message.readAt || message.isRead) {
                    statusIcon = '<span class="message-status read">✓✓</span>';
                } else {
                    statusIcon = '<span class="message-status sent">✓</span>';
                }
            }

            messageWrapper.innerHTML = `
                ${optionsButton}
                <div class="message-bubble ${isMine ? "mine" : "theirs"}">
                    ${!isMine && @Model.IsGroup.ToString().ToLower() ? `<div class="message-sender">${escapeHtml(message.senderName)}</div>` : ''}
                    <div class="message-content" id="message-content-${message.id}">${escapeHtml(message.content)}</div>
                    <div class="message-time">
                        ${message.sentAt}
                        ${statusIcon}
                    </div>
                </div>
            `;

            messagesDiv.appendChild(messageWrapper);
        }

        // HTML escape
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scroll
        function scrollToBottom() {
            const container = document.getElementById("messagesContainer");
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Enter ile gönder
        document.getElementById("messageInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("messageForm").dispatchEvent(new Event('submit'));
            }
        });

        // Sayfa yüklendiğinde mesajları okundu işaretle
        window.addEventListener("load", () => {
            scrollToBottom();
            document.getElementById("messageInput").focus();

            // ✨ Biraz gecikme ekle (DOM tamamen yüklensin)
            setTimeout(() => {
                connection.invoke("MarkConversationAsRead", conversationId)
                    .then(() => console.log("✅ Konuşma okundu olarak işaretlendi"))
                    .catch(err => console.error("❌ Mark as read hatası:", err));
            }, 500);
        });

        // Mesaj geldiğinde okundu olarak işaretle
        connection.on("ReceiveMessage", (message) => {
            if (message.conversationId === conversationId) {
                addMessageToUI(message, message.senderId === currentUserId);
                scrollToBottom();

                // ✨ Eğer bizim mesajımız değilse, HEMEN okundu olarak işaretle
                if (message.senderId !== currentUserId) {
                    setTimeout(() => {
                        connection.invoke("MarkMessageAsRead", message.id)
                            .then(() => console.log(`✅ Mesaj ${message.id} okundu işaretlendi`))
                            .catch(err => console.error("❌ Mark as read hatası:", err));
                    }, 300);
                }
            }
        });

        // Mesajlar okundu bildirimi (gönderen için)
        connection.on("MessagesRead", (messageIds) => {
            console.log("✅ Mesajlar okundu:", messageIds);
            messageIds.forEach(messageId => {
                updateMessageReadStatus(messageId, true);
            });
        });

        // Tek mesaj okundu bildirimi
        connection.on("MessageRead", (messageId) => {
            console.log("✅ Mesaj okundu:", messageId);
            updateMessageReadStatus(messageId, true);
        });

        // Mesaj durumu güncelleme
        function updateMessageReadStatus(messageId, isRead) {
            const messageWrapper = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageWrapper) {
                console.log("⚠️ Mesaj bulunamadı:", messageId);
                return;
            }

            const timeDiv = messageWrapper.querySelector('.message-time');
            if (!timeDiv) return;

            const statusSpan = timeDiv.querySelector('.message-status');
            if (statusSpan) {
                if (isRead) {
                    statusSpan.className = 'message-status read';
                    statusSpan.textContent = '✓✓';
                    console.log("✅ Tik güncellendi:", messageId);
                } else {
                    statusSpan.className = 'message-status sent';
                    statusSpan.textContent = '✓';
                }
            }
        }



        // Mesaj menüsü
        let currentMessageMenu = null;

        function showMessageMenu(event, messageId) {
            event.stopPropagation();
            event.preventDefault();

            // Eski menüyü kapat
            if (currentMessageMenu) {
                currentMessageMenu.remove();
            }

            // Yeni menü oluştur
            const menu = document.createElement('div');
            menu.className = 'message-menu';
            menu.innerHTML = `
                <div class="message-menu-item" onclick="editMessage(${messageId})">
                    ✏️ Düzenle
                </div>
                <div class="message-menu-item delete" onclick="deleteMessage(${messageId})">
                    🗑️ Sil
                </div>
            `;

            document.body.appendChild(menu);

            // Pozisyonla (appendChild'den SONRA)
            const rect = event.target.getBoundingClientRect();
            menu.style.position = 'absolute';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.left = (rect.left -70) + 'px';
            menu.style.zIndex = '9999';

            currentMessageMenu = menu;
        }

        // Menüyü kapat
        document.addEventListener('click', () => {
            if (currentMessageMenu) {
                currentMessageMenu.remove();
                currentMessageMenu = null;
            }
        });

        // Mesaj silme
        async function deleteMessage(messageId) {
            if (!confirm('Bu mesajı silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                await connection.invoke("DeleteMessage", messageId);

                // UI'dan kaldır
                const messageWrapper = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageWrapper) {
                    messageWrapper.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => messageWrapper.remove(), 300);
                }
            } catch (err) {
                console.error("Silme hatası:", err);
                alert("Mesaj silinemedi!");
            }
        }

        // Mesaj düzenleme
        function editMessage(messageId) {
            const messageContent = document.getElementById(`message-content-${messageId}`);
            const currentText = messageContent.textContent.trim();

            // Modal oluştur
            const modal = document.createElement('div');
            modal.className = 'edit-modal';
            modal.innerHTML = `
                <div class="edit-modal-content">
                    <h5 style="margin-bottom: 15px;">Mesajı Düzenle</h5>
                    <textarea id="editTextarea">${escapeHtml(currentText)}</textarea>
                    <div class="edit-modal-buttons">
                        <button class="btn btn-secondary" onclick="closeEditModal()">İptal</button>
                        <button class="btn btn-primary" onclick="saveEdit(${messageId})">Kaydet</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('editTextarea').focus();

            window.currentEditModal = modal;
        }

        function closeEditModal() {
            if (window.currentEditModal) {
                window.currentEditModal.remove();
                window.currentEditModal = null;
            }
        }

        async function saveEdit(messageId) {
            const newContent = document.getElementById('editTextarea').value.trim();

            if (!newContent) {
                alert('Mesaj boş olamaz!');
                return;
            }

            try {
                await connection.invoke("EditMessage", messageId, newContent);
                closeEditModal();
            } catch (err) {
                console.error("Düzenleme hatası:", err);
                alert("Mesaj düzenlenemedi!");
            }
        }

        // SignalR mesaj silme dinleyicisi
        connection.on("MessageDeleted", (messageId) => {
            const messageWrapper = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageWrapper) {
                messageWrapper.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => messageWrapper.remove(), 300);
            }
        });

        // SignalR mesaj düzenleme dinleyicisi
        connection.on("MessageEdited", (message) => {
            const messageWrapper = document.querySelector(`[data-message-id="${message.id}"]`);
            if (!messageWrapper) return;

            const contentDiv = messageWrapper.querySelector('.message-content');
            if (contentDiv) {
                contentDiv.textContent = message.content;
            }

            const timeDiv = messageWrapper.querySelector('.message-time');
            if (timeDiv) {
                // Düzenlendi badge'i ekle (eğer yoksa)
                if (!timeDiv.querySelector('.edited-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'edited-badge';
                    badge.textContent = 'düzenlendi';

                    const statusSpan = timeDiv.querySelector('.message-status');
                    if (statusSpan) {
                        timeDiv.insertBefore(badge, statusSpan);
                    } else {
                        timeDiv.appendChild(badge);
                    }
                }

                // ✨ Mavi tik durumu KORUNUR (değiştirilmez)
            }
        });

        // Animasyon CSS'i ekle
        const style = document.createElement('style');
        style.textContent = `
        @@keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.8); }
            }
        `;
        document.head.appendChild(style);

        // Resim yükleme
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Dosya boyutu kontrolü (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Dosya boyutu 5MB\'dan küçük olmalıdır!');
                event.target.value = '';
                return;
            }

            // Dosya tipi kontrolü
            if (!file.type.startsWith('image/')) {
                alert('Sadece resim dosyaları yüklenebilir!');
                event.target.value = '';
                return;
            }

            // Progress göster
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('conversationId', conversationId);

                // CSRF token ekle
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (token) {
                    formData.append('__RequestVerificationToken', token);
                }

                // Progress simülasyonu
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressBar.style.width = progress + '%';
                    }
                }, 100);

                const response = await fetch('/Chat/UploadImage', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (response.ok) {
                    const result = await response.json();

                    // SignalR ile resmi gönder
                    await connection.invoke("SendImageMessage", conversationId, result.messageId);

                    // Input'u temizle
                    event.target.value = '';

                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 500);
                } else {
                    const error = await response.json();
                    alert('Yükleme hatası: ' + (error.message || 'Bilinmeyen hata'));
                }
            } catch (err) {
                console.error('Upload error:', err);
                alert('Resim yüklenemedi!');
            } finally {
                progressDiv.style.display = 'none';
                event.target.value = '';
            }
        }

        // Resmi büyüt (modal)
        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <button class="image-modal-close" onclick="closeImageModal()">×</button>
                <img src="${imageUrl}" alt="Resim" />
            `;

            modal.onclick = function (e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            };

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            window.currentImageModal = modal;
        }

        function closeImageModal() {
            if (window.currentImageModal) {
                window.currentImageModal.remove();
                window.currentImageModal = null;
                document.body.style.overflow = 'auto';
            }
        }

        // ESC tuşu ile modal kapat
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && window.currentImageModal) {
                closeImageModal();
            }
        });

        // addMessageToUI fonksiyonunu güncelle
        function addMessageToUI(message, isMine) {
            const messagesDiv = document.getElementById("messagesList");

            const messageWrapper = document.createElement("div");
            messageWrapper.className = `message-wrapper ${isMine ? "mine" : "theirs"}`;
            messageWrapper.setAttribute('data-message-id', message.id);

            let optionsButton = '';
            if (isMine) {
                optionsButton = `<button class="message-options message-options-btn" onclick="showMessageMenu(event, ${message.id})">⋮</button>`;
            }

            let contentHtml = '';
            let bubbleClass = '';

            if (message.type === 'image') {
                // Resim mesajı
                bubbleClass = 'has-image';
                contentHtml = `
                    ${!isMine && @Model.IsGroup.ToString().ToLower() ? `<div class="message-sender" style="padding: 8px 8px 4px;">${escapeHtml(message.senderName)}</div>` : ''}
                    <div class="image-wrapper">
                        <img src="${escapeHtml(message.content)}"
                             alt="Resim"
                             class="message-image"
                             onclick="openImageModal('${escapeHtml(message.content)}')"
                             loading="lazy" />
                    </div>
                `;
            } else {
                // Text mesajı
                contentHtml = `
                    ${!isMine && @Model.IsGroup.ToString().ToLower() ? `<div class="message-sender">${escapeHtml(message.senderName)}</div>` : ''}
                    <div class="message-content" id="message-content-${message.id}">${escapeHtml(message.content)}</div>
                `;
            }

            let statusIcon = '';
            if (isMine) {
                if (message.readAt || message.isRead) {
                    statusIcon = '<span class="message-status read">✓✓</span>';
                } else {
                    statusIcon = '<span class="message-status sent">✓</span>';
                }
            }

            messageWrapper.innerHTML = `
                ${optionsButton}
                <div class="message-bubble ${bubbleClass} ${isMine ? "mine" : "theirs"}">
                    ${contentHtml}
                    <div class="message-time" ${bubbleClass ? 'style="padding: 4px 8px;"' : ''}>
                        ${message.sentAt}
                        ${statusIcon}
                    </div>
                </div>
            `;

            messagesDiv.appendChild(messageWrapper);
        }

    </script>
</body>
</html>